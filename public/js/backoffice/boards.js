/**
 * 게시판 관리 JavaScript
 * - 슬러그 자동 생성
 * - 커스텀 필드 관리
 * - 폼 유효성 검사
 */

// 게시판 이름 입력 시 자동으로 슬러그 생성
function initializeSlugGeneration() {
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');

    if (nameInput && slugInput) {
        nameInput.addEventListener('input', function() {
            if (!slugInput.value || slugInput._autoGenerated) {
                const slug = this.value
                    .toLowerCase()
                    .replace(/[^\w\s-]/g, '') // 영문자, 숫자, 공백, 하이픈만 허용
                    .replace(/\s+/g, '-')     // 공백을 하이픈으로 변환
                    .replace(/-+/g, '-');     // 중복된 하이픈 제거

                slugInput.value = slug;
                slugInput._autoGenerated = true;
            }
        });

        slugInput.addEventListener('input', function() {
            slugInput._autoGenerated = false;
        });
    }
}

// 커스텀 필드 관리
let customFieldCounter = 0;

// 페이지 로드 시 기존 필드 개수로 카운터 초기화
function initializeCustomFieldCounter() {
    const container = document.getElementById('customFieldsList');
    if (container) {
        customFieldCounter = container.children.length;
    }
}

function addCustomField() {
    const container = document.getElementById('customFieldsList');
    if (!container) {
        console.error('customFieldsList를 찾을 수 없습니다!');
        return;
    }
    
    const existingFields = container.children.length;
    const fieldId = 'custom_field_' + customFieldCounter++;
    
    const fieldHtml = `
        <div class="custom-field-item" id="${fieldId}">
            <div class="custom-field-header">
                <h6>커스텀 필드 #${existingFields + 1}</h6>
                <div class="custom-field-actions">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveCustomField('${fieldId}', 'up')" title="위로 이동">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveCustomField('${fieldId}', 'down')" title="아래로 이동">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCustomField('${fieldId}')">
                        <i class="fas fa-trash"></i> 삭제
                    </button>
                </div>
            </div>
            <div class="board-form-row">
                <div class="board-form-col board-form-col-6">
                    <div class="board-form-group">
                        <label class="board-form-label">필드명 <span class="required">*</span></label>
                        <input type="text" class="board-form-control" name="custom_fields[${existingFields}][name]" placeholder="예: location" required>
                        <small class="board-form-text">영문, 소문자, 언더스코어(_) 사용</small>
                    </div>
                </div>
                <div class="board-form-col board-form-col-6">
                    <div class="board-form-group">
                        <label class="board-form-label">라벨 <span class="required">*</span></label>
                        <input type="text" class="board-form-control" name="custom_fields[${existingFields}][label]" placeholder="예: 위치" required>
                        <small class="board-form-text">사용자에게 보여질 이름</small>
                    </div>
                </div>
            </div>
            <div class="board-form-row">
                <div class="board-form-col board-form-col-4">
                    <div class="board-form-group">
                        <label class="board-form-label">필드 타입 <span class="required">*</span></label>
                        <select class="board-form-control" name="custom_fields[${existingFields}][type]" onchange="toggleFieldOptions(this, ${existingFields})" required>
                            <option value="">타입 선택</option>
                            <option value="text">텍스트</option>
                            <option value="select">셀렉박스</option>
                            <option value="checkbox">체크박스</option>
                            <option value="radio">라디오 버튼</option>
                            <option value="editor">에디터</option>
                            <option value="date">날짜</option>                                
                        </select>
                    </div>
                </div>
                <div class="board-form-col board-form-col-4">
                    <div class="board-form-group">
                        <div class="board-checkbox-item">
                            <input type="checkbox" class="board-checkbox-input" name="custom_fields[${existingFields}][required]" value="1">
                            <label class="board-form-label">필수 입력</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="board-form-group field-options" id="field_options_${existingFields}" style="display: none;">
                <label class="board-form-label">선택 옵션</label>
                <textarea class="board-form-control" name="custom_fields[${existingFields}][options]" placeholder="한 줄에 하나씩 입력하세요&#10;예:&#10;일반&#10;프리미엄&#10;VIP" rows="3"></textarea>
            </div>
            <div class="board-form-group">
                <label class="board-form-label">플레이스홀더</label>
                <input type="text" class="board-form-control" name="custom_fields[${existingFields}][placeholder]" placeholder="예: 위치를 입력하세요">
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', fieldHtml);
    
    // 새 필드가 추가되면 히든 필드 제거 (하지만 기존 input은 유지)
    const existingHidden = document.getElementById('custom_fields_hidden');
    if (existingHidden) {
        existingHidden.remove();
    }
}

function removeCustomField(fieldId) {
    const fieldElement = document.getElementById(fieldId);
    if (fieldElement) {
        // 해당 필드 내부의 input 요소들만 제거
        const inputs = fieldElement.querySelectorAll('input, select, textarea');
        inputs.forEach(input => input.remove());
        
        // DOM 요소 제거
        fieldElement.remove();
        
        // 커스텀 필드가 모두 삭제되었을 때 빈 배열을 보장하기 위해 히든 필드 추가
        updateCustomFieldsHiddenInput();
    }
}

// 커스텀 필드 상태를 추적하는 히든 인풋 업데이트
function updateCustomFieldsHiddenInput() {
    const container = document.getElementById('customFieldsList');
    if (!container) return;
    
    // 기존 히든 필드 제거
    const existingHidden = document.getElementById('custom_fields_hidden');
    if (existingHidden) {
        existingHidden.remove();
    }
    
    // 커스텀 필드가 없으면 아무것도 추가하지 않음 (서버에서 null로 처리)
    // 빈 배열 히든 필드는 추가하지 않음
}

function moveCustomField(fieldId, direction) {
    const fieldElement = document.getElementById(fieldId);
    const container = document.getElementById('customFieldsList');
    
    if (!fieldElement || !container) return;
    
    if (direction === 'up' && fieldElement.previousElementSibling) {
        container.insertBefore(fieldElement, fieldElement.previousElementSibling);
    } else if (direction === 'down' && fieldElement.nextElementSibling) {
        container.insertBefore(fieldElement.nextElementSibling, fieldElement);
    }
}

function toggleFieldOptions(selectElement, fieldIndex) {
    const optionsContainer = document.getElementById(`field_options_${fieldIndex}`);
    if (optionsContainer) {
        const selectedType = selectElement.value;
        if (selectedType === 'select' || selectedType === 'checkbox' || selectedType === 'radio') {
            optionsContainer.style.display = 'block';
        } else {
            optionsContainer.style.display = 'none';
        }
    }
}

// 폼 유효성 검사
function validateBoardForm() {
    const requiredFields = document.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    return isValid;
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 슬러그 자동 생성 초기화
    initializeSlugGeneration();
    
    // 커스텀 필드 카운터 초기화
    initializeCustomFieldCounter();
    
    // 커스텀 필드 추가 버튼 이벤트 리스너
    const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');
    if (addCustomFieldBtn) {
        addCustomFieldBtn.addEventListener('click', addCustomField);
    }
    
    // 페이지 로드 시 커스텀 필드 상태 확인
    updateCustomFieldsHiddenInput();
    
    // 폼 제출 시 유효성 검사
    const boardForm = document.querySelector('form[action*="boards"]');
    if (boardForm) {
        boardForm.addEventListener('submit', function(e) {
            if (!validateBoardForm()) {
                e.preventDefault();
                alert('필수 항목을 모두 입력해주세요.');
            }
        });
    }
});
